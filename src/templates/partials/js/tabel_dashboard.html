<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<script>
        document.addEventListener("DOMContentLoaded", function() {
            const checkboxes = document.querySelectorAll(".batch-check");
            const batchRenameBtn = document.getElementById("batchRenameBtn");

            // Edit nama satu dataset
            document.querySelectorAll(".edit-name").forEach(button => {
                button.addEventListener("click", function() {
                    let row = this.closest("tr");
                    let id = row.dataset.id;
                    let newName = prompt("Masukkan nama baru:");
                    if (newName) {
                        fetch(`/update-reading/${id}/`, {
                            method: "POST",
                            headers: { "X-CSRFToken": "{{ csrf_token }}", "Content-Type": "application/x-www-form-urlencoded" },
                            body: `name=${newName}`
                        }).then(res => res.json()).then(data => {
                            if (data.success) row.querySelector(".name-field").textContent = data.new_name;
                        });
                    }
                });
            });

            // Batch rename
            batchRenameBtn.addEventListener("click", function() {
                let selected = Array.from(checkboxes).filter(c => c.checked).map(c => c.dataset.id);
                let newName = prompt("Masukkan nama baru untuk batch:");
                if (newName && selected.length) {
                    fetch("/batch-rename/", {
                        method: "POST",
                        headers: { "X-CSRFToken": "{{ csrf_token }}", "Content-Type": "application/x-www-form-urlencoded" },
                        body: new URLSearchParams({ "ids[]": selected, "name": newName })
                    }).then(res => res.json()).then(data => {
                        if (data.success) location.reload();
                    });
                }
            });

            // Export CSV
            document.getElementById("exportCSV").addEventListener("click", function() {
                let csv = "Nama,Tanggal,UV 410, VIS 560, NIR 810\n";
                document.querySelectorAll("#sensorTable tbody tr").forEach(row => {
                    let cols = row.querySelectorAll("td");
                    csv += `${cols[1].innerText},${cols[2].innerText},${cols[3].innerText},${cols[4].innerText},${cols[5].innerText}\n`;
                });
                let blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
                saveAs(blob, "sensor_data.csv");
            });
        });
</script>